## ДЛЯ ЧЕГО ОНО 
Делалось для хитрого (ниже подробнее) бекапа виртуалок (qemu) и lxc контейнеров в среде proxmox'a. В принципе, должно работать и без proxmox для обычных qemu. А для lxc таки потребуется проксмоксовая тула pct

Хитрость бекапов заключается том, что требуется ежедневно перевозить бекапы ВМ в удаленное хранилище (rsync) с ограничением трафика и требования по сроках хранения, поэтому все бекапы линкуются в спец. каталог по определенным правилам, откуда уже rsync`ается.

### фичи для удовлетворения всех хитростей
- Процессы генерации бекапов и процессы передачи их на хранилку должны быть независимы. Так как бекапы могут делаться в любое время
- Гарантировать, что передаваемые бекапы завершенные. Это гарантируется линкованием успешно созданных бекапов в спец. каталог
- Ограничение дневного(разового) объема передаваемых в удаленное хранилище  бекапов ВМ. 
- Управление сроками хранения бекапов ВМ  в локальном хранилище (на хостах где выполняется бекап) и в удаленном (remote)


## Пояснения почему подготовка каталога изолирована от собсно бекапов в формате диалога
Зачем  "подготовка  к выливке на хранилку" (суть: ln vm1 .rsync/vm1 ) выделен в
отдельный билд? Почему это не пускать сразу после выполнения бекапов ВМ?
    Так сделано потому, что были приняты следующие входные условия: 
    - Есть дневной лимит по rsync трафику, который надо учитывать. Из-за него и вся эта чешуя =) 
    - Дампы ВМ могут делаться не каждый день. 
    -  Из  всего  набора ВМ (бекапсета) могут сдампиться не все изза какой-нить
    ошибки. Но это не должно мешать слинковать успешно сдампленные ВМ
    - Скрипт должен завершаться с ошибкой, если дамп ВМ не получился. 
    - Лимит Гб в день понимать как Лимит трафика за один проход синхронизации.
      Т.е. прошла заливка, день закончился.

   1. Начну с самого скрипта. 
     - Почему нельзя пускать ln сразу после выполнения каждого дампа? 
          Чтобы работала система учета дневного лимита по rsync траффику,  надо видеть состояние всех прошедших дампов 
             (см. комменты внутри скрипта про вес дампа  превышающего дневной лимит и учет "тухлости") 
           
     -  Ну ок, а  после выполнения всех дампов? 
         А до этого места вообще не дойдет если к-л дамп завершился с ошибкой.  
         В текущей конфигурации логики хотяб  часть успешно сдампленных ВМ будет слинкована (читай засинкана на хранилку). 

    -  Ну а если не выходить сразу после сломавшегося дампа, а сохранять состояние в флагах и после того как будет выполнен весь пробег, пустить провизинг и выйти с флагом состояния - билд будет анстейбл если хоть один дамп завершился с ошибкой...ы? 
       Это будет работать при одном шедулере, а что если их два или больше прошло в один день?... нужно хранить "сегодняший" статус - сколько Гб уже напровизилось на этом хосте. 
        Даже если реализовать такой "флаг" - надо впиливать хитрожопую логику постоянной проверки состояния этого флага на случай, если шедулеры будут работать в одно время. например, один запустился позже, но предыдущий все-еще работает, а потом еще кто-то пришел... Т.е. флаг обновлять после каждого прошедшего дампа.  Вот чтобы избежать этот весь гемор проще тупо пускать провизинг днем =) 
   
     - А если допустить, что ВМ всегда дампятся успешно? 
        Представь картинку: Дамп некоего бекапсета выполняется раз в неделю. Ежедневный лимит предоставления трафика для хранилки 10Гб. 
             Надампилось 100Гб. 
             Сообразно, седня слинковалось 10Гб.  Ждем неделю. Слинковались следующие 10Гб (с учетом тухлости), еще неделя, еще 10Гб. 
             Прибавь к этому учет срока хранения дампов на самой хранилке... 
             В итоге какие-то ВМ могут не уехать на хранилку. 

        А с ежедневным запуском отдельного билда ежедневно будет "уезжать" в хранилку по 10Гб 

2. Ок, скрипт оставим в покое. Как насчет запуска последовательно самих билдов: "бекап, провижн"? 
       - ок, но требуется доп. конфигурации билда. Зато всего один дополнительный билд  к бекапсету вместо двух + нет временного гепа, что тоже хорошо - гадать не надо. 
       - в случае "как счас":    На сервер билд с целью линковки будет ходить всего один раз в день вместо N - по кол-ву билдов - меньше движухи, жизнь чуть легче =) 
                                                 других бонусов не вижу. 
       оба варианта не рушат логику и требования, поэтому жизнеспособны. Здесь только вопрос юзабилити. 
